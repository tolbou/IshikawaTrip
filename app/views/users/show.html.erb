<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">マイページ</h1>
  <div class="tabs mb-5">
    <button class="tab mr-7 border-b-2 border-transparent hover:border-gray-300" onclick="showTab('profile')">プロフィール設定</button>
    <button class="tab mr-7 border-b-2 border-transparent hover:border-gray-300" onclick="showTab('my-posts')">自分の投稿</button>
    <button class="tab mr-7 border-b-2 border-transparent hover:border-gray-300" onclick="showTab('liked-posts')">お気に入りの投稿</button>
  </div>

  <div id="profile" class="tab-content">
    <%= form_with model: @user, local: true, html: { multipart: true }, data: { turbo: false } do |f| %>
      <% if @user.errors.any? %>
        <div id="error_explanation" class="text-red-500">
          <ul>
            <% @user.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <div class="mb-4 mt-4">
        <%= image_tag @user.image.url, class: "w-24 h-24 rounded-full object-cover mb-2" if @user.image.present? %>
        <%= f.label :image, "プロフィール画像", class: "block text-gray-700 text-sm font-bold mb-2 inline" %>
        <%= f.file_field :image, class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline", accept: "image/jpeg,image/jpg,image/png,image/heic" %>
        <span class="text-xs text-gray-500">ファイル形式：jpeg、jpg、png、heic</span>
      </div>
      <div class="mb-4">
        <%= f.label :name, "ユーザー名", class: "block text-gray-700 text-sm font-bold mb-2 inline" %>
        <span class="text-red-500 inline">*</span>
        <%= f.text_field :name, value: @user.name, class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline", placeholder: "ユーザー名を入力してください" %>
      </div>
      <div class="mt-20">
        <%= f.submit "更新する", class: "bg-gray-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" %>
      </div>
    <% end %>
  </div>

  <div id="my-posts" class="tab-content hidden">
    <% @user.posts.each do |post| %>
      <div class="bg-gray-100 p-4 rounded-lg shadow mb-4 flex">
        <%= image_tag post.image.url, class: "w-36 h-36 rounded-lg object-cover mb-2" if post.image.present? %>
        <div class="ml-4 w-2/3">
          <h3 class="text-lg font-semibold text-gray-700 mb-2"><%= post.title %></h3>
          <p class="text-gray-600 mb-2">所在地</p>
          <p class="text-gray-600 mb-2"><%= post.address %></p>
          <div class="flex justify-end space-x-2">
            <%= link_to '編集', edit_post_path(post), class: "bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" %>
            <%= link_to '削除', post, method: :delete, data: { confirm: '本当に削除しますか？' }, class: "bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div id="liked-posts" class="tab-content hidden">
    <% @user.liked_posts.each do |post| %>
      <div class="bg-gray-100 p-4 rounded-lg shadow mb-4 flex">
        <%= image_tag post.image.url, class: "w-36 h-36 rounded-lg object-cover mb-2" if post.image.present? %>
        <div class="ml-4 w-2/3">
          <h3 class="text-lg font-semibold text-gray-700 mb-2"><%= post.title %></h3>
          <p class="text-gray-600 mb-2">所在地</p>
          <p class="text-gray-600 mb-2"><%= post.address %></p>
          <div class="flex justify-end space-x-2">
            <%= form_with(url: like_post_path(post), method: :post, remote: true, html: { id: "like-form-#{post.id}", data: { turbo: false } }) do %>
              <button type="submit" class="btn btn-primary flex items-center">
                <i class="<%= current_user.likes.exists?(post: post) ? 'fas fa-thumbs-up text-black' : 'far fa-thumbs-up text-gray-400' %>" id="like-icon-<%= post.id %>"></i>
              </button>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(function(content) {
      content.classList.add('hidden');
    });
    document.getElementById(tabId).classList.remove('hidden');

    document.querySelectorAll('.tab').forEach(function(tab) {
      tab.classList.remove('active', 'border-blue-500');
    });
    document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active', 'border-blue-500');
  }

  // 初期表示でプロフィール設定タブを表示
  document.addEventListener('DOMContentLoaded', function() {
    showTab('profile');
  });
</script>
